<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Prueba de API Final</title>
    <style>
        body { font-family: sans-serif; margin: 2em; max-width: 600px; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        select { width: 100%; padding: 8px; margin-top: 5px; }
        #recommendation-box { margin-top: 10px; padding: 10px; background-color: #f4f4f4; border-left: 3px solid #007bff; min-height: 20px; }
    </style>
</head>
<body>
    <h1>Prueba de Conexión Final</h1>
    <label for="category-select">Categoría:</label>
    <select id="category-select"><option value="">Llamando a Salesforce...</option></select>
    <div id="recommendation-box"></div>
    <label for="question-select">Pregunta Específica:</label>
    <select id="question-select"><option value="">Selecciona una categoría primero</option></select>

<script>
    const apiUrl = 'https://crossborderxpressmx--dev.sandbox.my.site.com/apipublica/services/apexrest/PreguntasFAQ';
    let faqData = {};

    const categorySelect = document.getElementById('category-select');
    const questionSelect = document.getElementById('question-select');
    const recommendationBox = document.getElementById('recommendation-box');

    document.addEventListener('DOMContentLoaded', fetchFaqData);
    categorySelect.addEventListener('change', handleCategoryChange);

    async function fetchFaqData() {
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`Error de red: ${response.status}`);
            
            // MÉTODO ROBUSTO: Leer como texto y convertir manualmente
            const responseText = await response.text();
            faqData = JSON.parse(responseText);

            populateCategories('es');
        } catch (error) {
            console.error("ERROR CRÍTICO:", error);
            categorySelect.innerHTML = '<option value="">Fallo la conexión o el procesamiento</option>';
            alert("Hubo un error. Revisa la consola (F12).");
        }
    }

    function populateCategories(lang) {
        categorySelect.innerHTML = `<option value="">-- Selecciona una categoría --</option>`;
        const categoriesList = faqData[lang]; // La llave es 'es' o 'en'
        
        if (!categoriesList) {
            console.error("Error: No se encontró la llave de idioma '" + lang + "' en los datos recibidos.", faqData);
            return;
        }

        categoriesList.forEach(category => {
            const option = document.createElement('option');
            option.value = category.categoryName;
            option.textContent = category.categoryName;
            categorySelect.appendChild(option);
        });
    }

    function handleCategoryChange() {
        const selectedCategoryName = categorySelect.value;
        const lang = 'es';
        if (selectedCategoryName) {
            const categoryData = faqData[lang].find(cat => cat.categoryName === selectedCategoryName);
            if (categoryData) {
                displayRecommendation(categoryData.recommendation);
                populateQuestions(categoryData.questions);
            }
        } else {
            displayRecommendation('');
            populateQuestions([]);
        }
    }

    function displayRecommendation(text) {
        recommendationBox.textContent = text || '';
    }

    function populateQuestions(questions) {
        questionSelect.innerHTML = `<option value="">-- Selecciona una pregunta --</option>`;
        if (questions && questions.length > 0) {
            questions.forEach(q => {
                const option = document.createElement('option');
                option.value = q.question;
                option.textContent = q.question;
                questionSelect.appendChild(option);
            });
        }
    }
</script>
</body>
</html>